name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run ESLint
      run: npm run lint
    
    - name: Run Prettier check
      run: npm run format:check

  validate-manifest:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Validate manifest.json
      run: |
        # Check if manifest.json is valid JSON
        jq empty manifest.json
        
        # Check required fields
        jq -e '.manifest_version' manifest.json
        jq -e '.name' manifest.json
        jq -e '.version' manifest.json
        jq -e '.description' manifest.json
        
        # Check if icons exist
        test -f icons/icon16.svg
        test -f icons/icon48.svg
        test -f icons/icon128.svg
        
        # Check if required files exist
        test -f content.js
        test -f popup.html
        test -f popup.js
        test -f background.js

  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Run security scan
      run: |
        # Check for common security issues
        echo "Checking for eval() usage..."
        if grep -r "eval(" *.js; then
          echo "Security warning: eval() found in code"
          exit 1
        fi
        
        echo "Checking for innerHTML usage..."
        if grep -r "innerHTML" *.js; then
          echo "Security warning: innerHTML found in code"
          exit 1
        fi
        
        echo "Security scan completed"

  build:
    runs-on: ubuntu-latest
    needs: [lint, validate-manifest, security-scan]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Create release package
      run: |
        mkdir -p dist
        cp -r *.js *.html *.json *.md icons/ dist/
        cd dist
        zip -r ../coursera-ai-remover.zip .
    
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: coursera-ai-remover
        path: coursera-ai-remover.zip